#!/bin/bash
set -e

echo "=== UNIFIED BUILD STARTING ==="

# 1. Clean Slate
rm -rf ramulator2
git clone https://github.com/CMU-SAFARI/ramulator2.git
cd ramulator2
git submodule update --init --recursive

# 2. Copy YOUR wrapper code into THEIR source folder
# (We assume your wrapper is at ../src/wrapper.cpp)
cp ../src/wrapper.cpp src/wrapper_integrated.cpp

echo "=== PATCHING CMAKE TO BUILD EVERYTHING ==="

# 3. Create a CMake target that compiles Ramulator AND your wrapper together
cat <<EOF >> src/CMakeLists.txt

# --- UNIFIED BUILD TARGET ---
# Gather all C++ files in the source tree
file(GLOB_RECURSE ALL_SRCS "*.cpp")
# Remove main.cpp so it doesn't conflict
list(FILTER ALL_SRCS EXCLUDE REGEX "main.cpp")

# Create ONE shared library containing EVERYTHING
add_library(ramulator_wrapper SHARED \${ALL_SRCS})

# Link dependencies (YAML, spdlog)
target_link_libraries(ramulator_wrapper PUBLIC yaml-cpp spdlog::spdlog)
target_include_directories(ramulator_wrapper PUBLIC \${CMAKE_CURRENT_SOURCE_DIR})
EOF

# 4. Compile
mkdir -p build
cd build

echo "=== COMPILING (This takes a minute) ==="
cmake .. \
    -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_PREFIX_PATH="$CONDA_PREFIX" \
    -DCMAKE_INCLUDE_PATH="$CONDA_PREFIX/include" \
    -DCMAKE_LIBRARY_PATH="$CONDA_PREFIX/lib"

make -j$(nproc)

# 5. Deliver the result
echo "=== FINISHING UP ==="
# Find the file wherever CMake put it
LIB_FILE=$(find . -name "libramulator_wrapper.so")

if [ -f "$LIB_FILE" ]; then
    cp "$LIB_FILE" ../../libramulator_wrapper.so
    echo "üéâ SUCCESS! The library is now in your main folder: libramulator_wrapper.so"
else
    echo "‚ùå Build failed. Please copy the error message above."
    exit 1
fi

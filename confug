#!/bin/bash
set -e

echo "=== 1. PREPARING RAMULATOR ==="
# Fix CMakeLists to force library creation
sed -i 's/add_executable(ramulator2/add_library(ramulator2 SHARED/g' ramulator2/src/CMakeLists.txt

echo "=== 2. BUILDING RAMULATOR CORE ==="
cd ramulator2
mkdir -p build
cd build
rm -rf * # Clean old bad build

# Run CMake pointing to Conda env
cmake .. \
    -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_PREFIX_PATH="$CONDA_PREFIX" \
    -DCMAKE_INCLUDE_PATH="$CONDA_PREFIX/include" \
    -DCMAKE_LIBRARY_PATH="$CONDA_PREFIX/lib"

make -j$(nproc)

echo "=== 3. VERIFYING LIBRARY ==="
# Find where the library actually landed
LIB_FILE=$(find . -name "libramulator2.so")

if [ -z "$LIB_FILE" ]; then
    echo "‚ùå Build failed. Library still not found."
    exit 1
fi

LIB_PATH=$(realpath $LIB_FILE)
LIB_DIR=$(dirname $LIB_PATH)
echo "‚úÖ Library created at: $LIB_PATH"

cd ../.. # Go back to main folder

echo "=== 4. BUILDING WRAPPER ==="
# Now we link using the EXACT path we just found
g++ -shared -fPIC -o libramulator_wrapper.so \
    src/wrapper.cpp \
    -I ramulator2/src \
    "$LIB_PATH" \
    -I "$CONDA_PREFIX/include" \
    -Wl,-rpath,"$LIB_DIR" \
    -O3

echo "üéâ SUCCESS! Created: $(pwd)/libramulator_wrapper.so"

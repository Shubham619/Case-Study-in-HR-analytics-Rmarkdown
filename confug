#include "base/base.h"
#include "base/request.h"
#include "base/config.h"
#include "frontend/frontend.h"
#include "memory_system/memory_system.h"
#include <iostream>
#include <string>

using namespace Ramulator;

int main(int argc, char** argv) {
    if (argc < 2) {
        std::cout << "ERROR: No config file provided" << std::endl;
        return 1;
    }

    // 1. Load Config
    std::string config_file = argv[1];
    YAML::Node config = YAML::LoadFile(config_file);

    // 2. Create Memory System
    auto* memory_system = Factory<IMemorySystem>::create(
        config["MemorySystem"]["impl"].as<std::string>(), 
        config["MemorySystem"], 
        nullptr
    );

    // 3. Signal Ready
    std::cout << "READY" << std::endl;

    // 4. Command Loop (Listens to Python)
    std::string command;
    long addr;
    int type_int;

    while (std::cin >> command) {
        if (command == "EXIT") {
            break;
        } 
        else if (command == "TICK") {
            memory_system->tick();
            std::cout << "OK" << std::endl;
        } 
        else if (command == "REQ") {
            // Format: REQ <addr> <type_int>
            std::cin >> addr >> type_int;
            
            Request req(addr, (Request::Type)type_int);
            bool accepted = memory_system->send(req);
            
            std::cout << (accepted ? "ACCEPTED" : "STALLED") << std::endl;
        }
    }

    // Cleanup
    memory_system->finalize();
    return 0;
}
